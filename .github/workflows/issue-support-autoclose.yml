name: Auto-Close Support Issues
on:
  issues:
    types: [opened, edited, reopened]

jobs:
  check-issue-content:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for closure triggers
        id: check-content
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const patterns = [/Otherwise, it will be closed immediately!/i, /#autocloseme/i];
            const shouldClose = patterns.some(pattern => pattern.test(body));
            return shouldClose;
          result-encoding: string

      - name: Close issue if triggered
        env:
          GH_TOKEN: ${{ github.token }}
        if: steps.check-content.outputs.result == 'true'
        run: |
          gh issue close ${{ github.event.issue.number }} --comment "This issue has been automatically closed due to detected #autocloseme."
          gh issue lock ${{ github.event.issue.number }} --reason resolved
